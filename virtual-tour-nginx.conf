# Nginx Configuration for Virtual Tour Project (Backend for Reverse Proxy)
# Static HTML tour without PHP
# Designed to run behind a reverse proxy (SSL termination at proxy)

server {
    # Listen on all interfaces for reverse proxy access
    # From external reverse proxy server
    listen 8080;
    
    # CRITICAL: Secure port 8080 with firewall!
    # Only allow access from your reverse proxy server IP
    # Example: ufw allow from REVERSE_PROXY_IP to any port 8080
    
    # Document root
    root /var/www/virtual-tour;
    index index.html index.htm;
    
    # Logging with real IP from reverse proxy
    access_log /var/log/nginx/virtual-tour-access.log;
    error_log /var/log/nginx/virtual-tour-error.log;
    
    # Trust reverse proxy for real IP
    # Add your reverse proxy IP here
    set_real_ip_from 127.0.0.1;
    set_real_ip_from 10.0.0.0/8;     # Internal networks
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    real_ip_header X-Real-IP;
    real_ip_recursive on;
    
    # Security headers removed - handled by reverse proxy
    
    # XML files for krpano configurations
    location ~ \.xml$ {
        expires 1h;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # JavaScript files
    location ~ \.js$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # SWF files (Flash/Shockwave)
    location ~ \.swf$ {
        add_header Content-Type "application/x-shockwave-flash";
        expires 1d;
        add_header Cache-Control "public";
        access_log off;
    }
    
    # Image files
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # CSS files
    location ~ \.css$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Font files
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        add_header Access-Control-Allow-Origin "*";
    }
    
    # Main location block
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Deny access to backup files
    location ~ \.(bak|config|dist|fla|in[ci]|log|psd|sh|sql|swp)$ {
        deny all;
    }
    
    # Handle large uploads and tile requests
    client_max_body_size 100M;
    client_body_timeout 300;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;
    
    # Disable gzip for SWF files
    location ~ \.swf$ {
        gzip off;
    }
}

